using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;

namespace nslds.domain.Migrations
{
    public partial class GlobalSqlUtils : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            //return;
            // custom migration to inject the Global.Sql.Utils assembly, functions & search SP
            var sql1 =

@"CREATE ASSEMBLY [Global.Sql.Utils]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300B2A876580000000000000000E00002210B010B00000C00000006000000000000FE290000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000A82900005300000000400000C802000000000000000000000000000000000000006000000C000000702800001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000040A000000200000000C000000020000000000000000000000000000200000602E72737263000000C80200000040000000040000000E0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001200000000000000000000000000004000004200000000000000000000000000000000E0290000000000004800000002000500382200003806000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300400D300000001000011000F00280500000A2D0C0F01280500000A16FE012B011600130A110A2D0E0014280600000A130938A40000000F00FE16020000016F0700000A0B0F01FE16020000016F0700000A0C730800000A0D730900000A1304110409086F0A00000A6F0B00000A1305730C00000A1306110611056F0D00000A001106186F0E00000A001106186F0F00000A0009076F0A00000A13070011066F1000000A1308110811071611078E696F1100000A0A00DE130011066F1200000A0011046F1300000A0000DC0006281400000A731500000A13092B0011092A0001100000020091001CAD0013000000001B300400D300000001000011000F00280500000A2D0C0F01280500000A16FE012B011600130A110A2D0E0014280600000A130938A40000000F00FE16020000016F0700000A0B0F01FE16020000016F0700000A0C730800000A0D730900000A1304110409086F0A00000A6F0B00000A1305730C00000A1306110611056F0D00000A001106186F0E00000A001106186F0F00000A0007281600000A13070011066F1700000A1308110811071611078E696F1100000A0A00DE130011066F1200000A0011046F1300000A0000DC0009066F1800000A731500000A13092B0011092A0001100000020090001CAC0013000000001E02281900000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C00000004020000237E000070020000F002000023537472696E6773000000006005000008000000235553006805000010000000234755494400000078050000C000000023426C6F620000000000000002000001471502000900000000FA2533001600000100000011000000020000000300000004000000190000000500000001000000010000000200000000000A00010000000000060044003D000A006C0057000600AD009A000F00C10000000600F000D00006001001D0000A005A013F0106009B018F010600C501A8010600DE018F010600F001A80106000A02A80106002902A80106004402A80106005802A80106007002A8010600AB023D000000000001000000000001000100010010001F000000050001000100502000000000960076000A00010040210000000096007F000A0003003022000000008618880013000500000001008E00000002009400000001008E00000002009400190088001700290088001D0031008800130039008800130011006F01270011007A012B000900860131004100880013004900880013005100E70135005900FE013B0061008800130069003C02420069004F024800690064024E006900810254008100910259006900A50213005900A50213008900B30262001100880068008900C20283006900D30254005100E30289000900880013002000230022002E000B008F002E00130098002E001B00A1004000230022006D000480000000000000000000000000000000002E010000020000000000000000000000010034000000000002000000000000000000000001004B00000000000000003C4D6F64756C653E00476C6F62616C2E53716C2E5574696C732E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E67005F656E6372797074005F64656372797074002E63746F720076616C756500746F6B656E0053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500476C6F62616C2E53716C2E5574696C73004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465006765745F49734E756C6C006F705F496D706C6963697400546F537472696E670053797374656D2E546578740055544638456E636F64696E670053797374656D2E53656375726974792E43727970746F677261706879004D443543727970746F5365727669636550726F766964657200456E636F64696E670047657442797465730048617368416C676F726974686D00436F6D707574654861736800547269706C6544455343727970746F5365727669636550726F76696465720053796D6D6574726963416C676F726974686D007365745F4B6579004369706865724D6F6465007365745F4D6F64650050616464696E674D6F6465007365745F50616464696E67004943727970746F5472616E73666F726D00437265617465456E63727970746F72005472616E73666F726D46696E616C426C6F636B00436C65617200436F6E7665727400546F426173653634537472696E670046726F6D426173653634537472696E6700437265617465446563727970746F7200476574537472696E670000000000032000000000006293B219AF4DF444A52E225009A192E40008B77A5C561934E08908000211091109110903200001052001011111042001010804010000000320000205000111090E0320000E0520011D050E0620011D051D05052001011D0505200101113905200101113D04200012410820031D051D0508080500010E1D05042001010E15070B1D050E0E122112251D0512311D0512411109020500011D050E0520010E1D050801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000B2A8765800000000020000001C0100008C2800008C0A000052534453A45128846E064048BDBDEB81921CD00508000000633A5C4445565C4E45585447454E5C4461746162617365315C4461746162617365315C6F626A5C44656275675C476C6F62616C2E53716C2E5574696C732E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D02900000000000000000000EE290000002000000000000000000000000000000000000000000000E029000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000006C02000000000000000000006C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004CC010000010053007400720069006E006700460069006C00650049006E0066006F000000A801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000004C001500010049006E007400650072006E0061006C004E0061006D006500000047006C006F00620061006C002E00530071006C002E005500740069006C0073002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005400150001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000047006C006F00620061006C002E00530071006C002E005500740069006C0073002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000003A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE";

            var sql2 =

@"CREATE FUNCTION dbo.Encrypt(@value NVARCHAR(MAX), @token NVARCHAR(MAX)) RETURNS NVARCHAR(MAX)
AS EXTERNAL NAME [Global.Sql.Utils].[UserDefinedFunctions].[_encrypt]";

            var sql3 =

@"CREATE FUNCTION dbo.Decrypt(@value NVARCHAR(MAX), @token NVARCHAR(MAX)) RETURNS NVARCHAR(MAX)
AS EXTERNAL NAME [Global.Sql.Utils].[UserDefinedFunctions].[_decrypt]";

            var sql4 =

@"CREATE PROCEDURE [nslds].[StudentSearch] 
	-- Add the parameters for the stored procedure here
	@cpid int,
	@startdate datetime, 
	@enddate datetime,
	@ssn nvarchar(450),
	@name1 nvarchar(100),
	@name2 nvarchar(100),
	@name3 nvarchar(100),
	@dob datetime,
	@openay bit,
	@hasfah bit
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	select rs.id as StudentId, rs.link2clientrequest as BatchId, 
	rs.encssn, rs.FirstName, rs.LastName, rs.DOB, 
	rs.RevOn as RequestDate, rs.isreceived, rs.ReceivedOn as ReceivedDate, 
	rs.Response as ResponseRoute, rs.StartDate 
	from nslds.clientrequeststudent rs
	inner join nslds.clientrequest cr on (rs.link2clientrequest = cr.id)
	where (cr.link2clientprofile = @cpid)
	and (rs.revon between @startdate and @enddate)
	and (@ssn is null or rs.encssn = @ssn)
	and (@dob is null or rs.dob = @dob)
	and (@name1 is null or upper(rs.firstname) like '%'+@name1+'%' or upper(rs.lastname) like '%'+@name1+'%')
	and (@name2 is null or upper(rs.firstname) like '%'+@name2+'%' or upper(rs.lastname) like '%'+@name2+'%')
	and (@name3 is null or upper(rs.firstname) like '%'+@name3+'%' or upper(rs.lastname) like '%'+@name3+'%')
	and (@openay is null or rs.startdate is not null)
	and (@hasfah = 0 or rs.isreceived = 1)
	;
END";
            migrationBuilder.Sql(sql1);
            migrationBuilder.Sql(sql2);
            migrationBuilder.Sql(sql3);
            migrationBuilder.Sql(sql4);
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
        }
    }
}
